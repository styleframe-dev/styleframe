name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

# Cancel in-progress runs for the same workflow/ref
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
    # Turbo configuration
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ vars.TURBO_TEAM }}
    TURBO_REMOTE_ONLY: true
    # Node configuration
    NODE_VERSION: 22

jobs:
    # Build job runs first to generate artifacts
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build packages
              run: pnpm build --filter '!@styleframe/docs'
              env:
                  NODE_ENV: production

            - name: Build docs
              run: pnpm build --filter '@styleframe/docs'
              env:
                  NODE_ENV: production

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      engine/*/dist
                      theme/*/dist
                      apps/docs/.nuxt
                  retention-days: 7

            - name: Upload node_modules for downstream jobs
              uses: actions/upload-artifact@v4
              with:
                  name: node-modules
                  path: |
                      node_modules
                      engine/*/node_modules
                      theme/*/node_modules
                      apps/*/node_modules
                  retention-days: 1

    # Lint job - runs oxlint and biome format check
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Download node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node-modules

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Run oxlint
              run: pnpm lint

            - name: Check formatting with Biome
              run: pnpm run format:check

    # Type checking job
    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Download node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node-modules

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Run type checking
              run: pnpm typecheck

    # Test job
    test:
        name: Test
        runs-on: ubuntu-latest
        needs: build
        strategy:
            fail-fast: false
            matrix:
                shard: [1, 2]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Download node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node-modules

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Run tests (shard ${{ matrix.shard }})
              run: pnpm test -- --shard=${{ matrix.shard }}/2
              env:
                  NODE_ENV: test

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./engine/*/coverage/lcov.info,./theme/*/coverage/lcov.info
                  flags: unittests-shard-${{ matrix.shard }}
                  name: codecov-shard-${{ matrix.shard }}
                  fail_ci_if_error: false
