name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

# Cancel in-progress runs for the same workflow/ref
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
    # Turbo configuration
    TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    TURBO_TEAM: ${{ vars.VERCEL_TEAM }}
    TURBO_CACHE: remote:rw
    # Node configuration
    NODE_VERSION: 22

jobs:
    # Build job runs first to generate artifacts (excluding docs)
    build:
        name: Build Packages
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build packages
              run: pnpm build --filter '!@styleframe/docs'
              env:
                  NODE_ENV: production

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      engine/*/dist
                      theme/*/dist
                      tooling/*/dist
                  retention-days: 7

    # Build docs separately
    build-docs:
        name: Build Docs
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build docs
              run: pnpm build --filter '@styleframe/docs'
              env:
                  NODE_ENV: production

            - name: Upload docs build
              uses: actions/upload-artifact@v4
              with:
                  name: docs-build
                  path: docs/.nuxt
                  retention-days: 7

    # Lint job - runs oxlint and biome format check
    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download build artifacts
              uses: actions/download-artifact@v5
              with:
                  name: build-artifacts
                  path: .

            - name: Run oxlint
              run: pnpm lint

            - name: Check formatting with Biome
              run: pnpm run format:check

    # Type checking job
    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download build artifacts
              uses: actions/download-artifact@v5
              with:
                  name: build-artifacts
                  path: .

            - name: Run type checking
              run: pnpm typecheck

    # Test job
    test:
        name: Test
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download build artifacts
              uses: actions/download-artifact@v5
              with:
                  name: build-artifacts
                  path: .

            - name: Run tests
              run: pnpm test -- --coverage
              env:
                  NODE_ENV: test

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./engine/*/coverage/lcov.info,./theme/*/coverage/lcov.info
                  slug: styleframe-dev/styleframe
